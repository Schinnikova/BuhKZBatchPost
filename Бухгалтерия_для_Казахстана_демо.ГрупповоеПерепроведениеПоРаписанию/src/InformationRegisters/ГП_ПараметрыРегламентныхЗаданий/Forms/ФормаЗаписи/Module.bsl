#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Установка доступных типов - только проводимые документы
	УстановитьДоступныеТипыДокументов();
	
	// Восстановление списка организаций из хранилища
	Если ЗначениеЗаполнено(Запись.ВыбранныеОрганизации) Тогда
		МассивОрганизаций = Запись.ВыбранныеОрганизации.Получить();
		Если ТипЗнч(МассивОрганизаций) = Тип("Массив") Тогда
			Организации.ЗагрузитьЗначения(МассивОрганизаций);
		КонецЕсли;
	КонецЕсли;
	
	// Восстановление выбранных типов из строки
	Если ЗначениеЗаполнено(Запись.ВыбранныеТипыСтрокой) Тогда
		ВыбранныеТипыДляОтбора = СтрРазделить(Запись.ВыбранныеТипыСтрокой, ";");
		МассивТипов = Новый Массив;
		
		Для Каждого ИмяТипа Из ВыбранныеТипыДляОтбора Цикл
			ОбъектМетаданных = Метаданные.Документы.Найти(ИмяТипа);
			Если ОбъектМетаданных <> Неопределено Тогда
				МассивТипов.Добавить(Тип("ДокументСсылка." + ИмяТипа));
			КонецЕсли;
		КонецЦикла;
		
		Если МассивТипов.Количество() > 0 Тогда
			ВыбранныеТипы = Новый ОписаниеТипов(МассивТипов);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	// Сохранение организаций в хранилище
	МассивОрганизаций = Организации.ВыгрузитьЗначения();
	ТекущийОбъект.ВыбранныеОрганизации = Новый ХранилищеЗначения(МассивОрганизаций);
	
	// Сохранение выбранных типов в строку
	ВыбранныеТипыДляОтбора = Новый Массив;
	Если ВыбранныеТипы <> Неопределено Тогда
		Для Каждого Тип Из ВыбранныеТипы.Типы() Цикл
			ОбъектМетаданных = Метаданные.НайтиПоТипу(Тип);
			Если Метаданные.Документы.Содержит(ОбъектМетаданных) Тогда
				ВыбранныеТипыДляОтбора.Добавить(ОбъектМетаданных.Имя);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	ТекущийОбъект.ВыбранныеТипыСтрокой = СтрСоединить(ВыбранныеТипыДляОтбора, ";");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьДоступныеТипыДокументов()
	
	// Устанавливаем ограничение типов для элемента формы
	Элементы.ВыбранныеТипы.ОграничениеТипа = ГП_ОбщийМодуль.ПолучитьОграничениеТипаПроводимыхДокументов();
	
КонецПроцедуры

#КонецОбласти